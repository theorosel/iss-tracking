function App(e){this.$el={},this.$el.container=e,this.$el.feeds=this.$el.container.querySelector(".feed-area-container"),this.$el.earth_area=this.$el.container.querySelector(".earth-area"),this.$el.altitude=this.$el.container.querySelector(".altitude"),this.$el.speed=this.$el.container.querySelector(".speed"),this.$el.city_over=this.$el.container.querySelector(".city"),this.$el.iss_btn=this.$el.container.querySelector(".iss-button"),this.$el.feed_link=this.$el.container.querySelector(".link-feed"),this.$el.team_link=this.$el.container.querySelector(".link-team"),this.$el.earth=this.$el.container.querySelector("#earth"),this.options={atmosphere:!1,center:[0,0],zoom:2.5,zooming:!1,unconstrainedRotation:!0,sky:!0},this.earth=new WE.map("earth",this.options),this.path=[],this.ship_path=[],this.latest_tweets=[];var t=this;this.initialize_earth=function(){WE.tileLayer("http://tileserver.maptiler.com/nasa/{z}/{x}/{y}.jpg",{minZoom:0,maxZoom:300,zooming:!1,attribution:"NASA"}).addTo(this.earth)},this.$el.feed_link.addEventListener("click",function(e){t.toggle_feed()}),this.$el.team_link.addEventListener("click",function(e){t.toggle_team()}),this.init=function(){this.initialize_earth(),this.get_iss_data(),this.get_latest_tweets().then(function(e){for(var s=0;s<t.latest_tweets.length-1;s++)t.get_tweet_pos(t.latest_tweets[s].tweet_date,s)})},this.get_latest_tweets=function(){return new Promise(function(e,s){var i=new XMLHttpRequest;i.open("GET","/api/twitter"),i.onload=function(){if(200==i.status){e(i.response);for(var a=JSON.parse(i.response),n=0;n<a.length;n++)t.latest_tweets.push(a[n])}else s(Error(i.statusText))},i.onerror=function(){s(Error("Network Error"))},i.send()})},this.get_tweet_pos=function(e,s){return new Promise(function(i,a){var n=new XMLHttpRequest;n.open("GET","https://api.wheretheiss.at/v1/satellites/25544/positions?timestamps="+e+"&units=miles"),n.onload=function(){if(200==n.status){i(n.response);var e=JSON.parse(n.response)[0].latitude,r=JSON.parse(n.response)[0].longitude;t.latest_tweets[s].lat=e,t.latest_tweets[s].lon=r,t.add_mark(s),t.print_tweet_feed(s)}else a(Error(n.statusText))},n.onerror=function(){a(Error("Network Error"))},n.send()})},this.get_iss_data=function(){var e=new XMLHttpRequest;e.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(this.responseText).altitude,s=JSON.parse(this.responseText).latitude,i=JSON.parse(this.responseText).longitude,a=JSON.parse(this.responseText).velocity;t.draw_travel(s,i),t.get_city_overflown(s,i),t.update_speed(a),t.update_altitude(e),t.move_iss(s,i),t.iss_cropping(s,i)}},e.open("GET","https://api.wheretheiss.at/v1/satellites/25544&units=miles",!0),e.send()},this.update_iss_data=function(){var e=new XMLHttpRequest;e.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(this.responseText).altitude,s=JSON.parse(this.responseText).latitude,i=JSON.parse(this.responseText).longitude,a=JSON.parse(this.responseText).velocity;t.draw_travel(s,i),t.get_city_overflown(s,i),t.update_speed(a),t.update_altitude(e),t.move_iss(s,i)}},e.open("GET","https://api.wheretheiss.at/v1/satellites/25544&units=miles",!0),e.send()},this.iss_cropping=function(e,t){this.earth.panTo([e,t])},this.get_city_overflown=function(e,s){var i=new XMLHttpRequest;i.onreadystatechange=function(){if(4==this.readyState&&200==this.status){var e=JSON.parse(this.responseText).timezone_id,s=e.split("/"),e=s[0]+" - "+s[1];t.$el.city_over.innerText="",t.$el.city_over.innerText=e}else if(4==this.readyState&&200!=this.status){var e="Ocean";t.$el.city_over.innerText="",t.$el.city_over.innerText=e}},i.open("GET","https://api.wheretheiss.at/v1/coordinates/"+e+","+s,!0),i.send()},this.draw_travel=function(e,t){var s=WE.marker([e,t]).addTo(this.earth);$path=s.element.firstChild,$path.classList.remove("we-pm-icon"),$path.removeAttribute("style"),$path.classList.add("we-pm-icon-path"),this.path.length<=150?this.path.push($path):(this.path[0].remove(),this.path.shift(),this.path.push($path))},this.move_iss=function(e,t){var s=WE.marker([e,t]).addTo(this.earth);$ship=s.element.firstChild,$ship.classList.remove("we-pm-icon"),$ship.removeAttribute("style"),$ship.classList.add("we-pm-icon-ship"),this.ship_path.length<=1?this.ship_path.push($ship):(this.ship_path[0].remove(),this.ship_path.shift(),this.ship_path.push($ship))},this.print_tweet_feed=function(e){$feed=document.createElement("div"),$feed.classList.add("feed"),$image=document.createElement("img"),$image.classList.add("feed-image"),$image.setAttribute("src",t.latest_tweets[e].picture),$name=document.createElement("h2"),$name.classList.add("feed-name"),$name.innerText=t.latest_tweets[e].name,$pseudo=document.createElement("p"),$pseudo.classList.add("feed-pseudo"),$pseudo.innerText="@ "+t.latest_tweets[e].pseudo,$text=document.createElement("p"),$text.classList.add("feed-text"),$text.innerText=t.latest_tweets[e].tweet_text,$feed.appendChild($image),$name.appendChild($pseudo),$feed.appendChild($name),$feed.appendChild($text),t.$el.feeds.appendChild($feed),$feed.addEventListener("click",function(s){$popup=t.latest_tweets[e].obj.parentElement.lastChild,console.log(t.latest_tweets[e]),t.earth.panTo([t.latest_tweets[e].lat,t.latest_tweets[e].lon]),$popup.classList.toggle("active"),$feed.classList.toggle("active"),event.preventDefault()}),this.$el.earth_area.addEventListener("click",function(s){$popup=t.latest_tweets[e].obj.parentElement.lastChild,$popup.classList.contains("active")&&$popup.classList.remove("active"),event.preventDefault()})},this.add_mark=function(e){var s=WE.marker([this.latest_tweets[e].lat,this.latest_tweets[e].lon]).addTo(this.earth);$marker=s.element.firstChild,$marker.classList.remove("we-pm-icon"),$marker.removeAttribute("style"),$marker.setAttribute("id",this.latest_tweets[e].id),$marker.classList.add("we-pm-icon-marker"),t.create_popup(s.element,e),t.latest_tweets[e].obj=$marker},this.create_popup=function(e,s){$popup=document.createElement("div"),$popup.classList.add("marker-popup"),$popup_header=document.createElement("div"),$popup_header.classList.add("popup-header"),$image=document.createElement("img"),$image.classList.add("popup-image"),$image.setAttribute("src",t.latest_tweets[s].picture),$name=document.createElement("h2"),$name.classList.add("popup-name"),$name.innerText=t.latest_tweets[s].name,$text=document.createElement("p"),$text.classList.add("popup-text"),$text.innerText=t.excerpt(t.latest_tweets[s].tweet_text),$popup_header.appendChild($image),$popup_header.appendChild($name),$popup.appendChild($popup_header),$popup.appendChild($text),e.appendChild($popup),e.addEventListener("mouseover",function(){this.lastChild.style.opacity=1,this.lastChild.style.transform="scale(1)"}),e.addEventListener("mouseleave",function(){this.lastChild.style.opacity=0,this.lastChild.style.transform="scale(0)"})},this.update_speed=function(e){e=e.toString(),e=e.substring(0,8),this.$el.speed.innerText="",this.$el.speed.innerText=e+" km/h"},this.update_altitude=function(e){e=e.toString(),e=e.substring(0,6),this.$el.altitude.innerText="",this.$el.altitude.innerText=e+" kilometers"},this.toggle_feed=function(){this.$el.feed_link.classList.toggle("active"),this.$el.container.classList.toggle("feed-mode"),this.$el.team_link.classList.remove("active"),this.$el.container.classList.remove("team-mode")},this.toggle_team=function(){this.$el.team_link.classList.toggle("active"),this.$el.container.classList.toggle("team-mode"),this.$el.feed_link.classList.remove("active"),this.$el.container.classList.remove("feed-mode")},this.excerpt=function(e){return e=e.trim(),text_length=e.length,text_length>=400?e=e.substring(0,400):e}}var earth=new App(document.querySelector(".app"));document.addEventListener("DOMContentLoaded",function(){earth.init()});